---
title: "Actuarial Firms 2016 - 2021"
output: html_document
date: "2023-07-20"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(stringr)
library(ggplot2)
options(scipen = 999)
```

# Numbers as appeared in the commentary:
```{r}
# number of plan in 2021
final_data_16_21 %>% filter(fy == 2021) %>% select(PlanName) %>% distinct()

# number of firms in 2021
final_data_16_21 %>% filter(fy == 2021) %>% select(actuarial_firm_name) %>% distinct()
```



```{r}
# What plans are covered by GRS?
final_data_16_21 %>% filter(fy == 2021) %>% 
  filter(str_detect(actuarial_firm_name, "GRS")) %>% 
  arrange(desc(ActLiabilities_GASB))

# What plans are covered by Cavanaugh Macdonald Consulting ?
final_data_16_21 %>% filter(fy == 2021) %>% 
  filter(str_detect(actuarial_firm_name, "Cavanaugh Macdonald Consulting")) %>% 
  arrange(desc(ActLiabilities_GASB))

# Teachers Retirement System of Georgia 
# 115703568000/1000000000
# Virginia Retirement System 
# 106643384000/1000000000
```


```{r}
data <- rio::import("Actuarial Firm Summary.xlsx", sheet = 2) %>% # shee2 = final_data_summary3_21
 
  add_column(firm_name_short = c("CalPERS", "Cavanaugh Macdonald", "Cheiron",
                            "Conduent", "Foster & Foster", "GRS",
                            "Internal Actuarial Services", "Korn Ferry Hay Group", "Milliman",
                            "NYC Office of the Actuary", "NY State & LRS Actuary", "Nystrs Office of The Actuary", 
                            "Office of The State Actuary - Washington", "PWC", "Segal", 
                            "Others")) %>% 
  mutate(AAL_percent = round(AAL_percent*100, 1),
         AAL_billion = round(AAL/1000000000),
         AAL_billion = paste0("$", AAL_billion, "B"),
         
         UAL_billion = round(UAL/1000000000),
         UAL_billion = paste0("$", UAL_billion, "B")) 

  # mutate(AAL = prettyNum(AAL, big.mark = ","),
  #        UAL = prettyNum(UAL, big.mark = ","))

  
```


# Top 15 firms in 2021 AAL
```{r}
data %>% 
  ggplot(aes(fct_reorder(firm_name_short, AAL), AAL)) +
  geom_col(fill = "#FF6632") +
  geom_col(data = data %>% filter(actuarial_firm_name == "Others"), 
           fill = "gray")+
  
  geom_text(aes(label = AAL_billion), color = "black", size = 2, 
            nudge_y = -30000000000) +
  coord_flip() +
  labs(x = "", 
       y = "Actuarial Accrued Liability") +
  scale_y_continuous(breaks = c(500000000000, 1000000000000, 1490000000000),
                   label = c("$500B","$1T","$1.5T")) +
  theme(plot.margin = margin(2, 8, 6, 2, "pt")) +
  theme_minimal() 
  
```

```{r}
# Next group
final_data_16_21 %>% filter(fy == 2021) %>% 
  filter(str_detect(actuarial_firm_name, "Milliman")) %>% 
  arrange(desc(ActLiabilities_GASB))

#California State Teachers' Retirement System
332081984000/1000000000	
#Florida Retirement System
209636048000/1000000000

# CalPERS
final_data_16_21 %>% filter(fy == 2021) %>% 
  filter(str_detect(actuarial_firm_name, "CalPERS")) %>% 
  arrange(desc(ActLiabilities_GASB))

#California Public Employees Retirement Fund
587976000000/1000000000	

# look at those who have overfunded plans
 final_data_16_21 %>% filter(fy == 2021) %>% filter(UAL <0) %>% 
   select(actuarial_firm_name, plan_name, UAL) %>% 
   group_by(actuarial_firm_name) %>% 
   mutate(tot = sum(UAL))  %>% select(actuarial_firm_name, tot)%>% arrange(tot) %>% distinct()
   

```


# Comparing AAL 2016 - 2021
```{r}

compare_top5 <-  final_data_summary2_16 %>% rbind(final_data_summary2_21) %>% 
  select(-AAL_percent) %>% 
  
  # The data does not have CalPERS 2016. Use number in the article https://reason.org/commentary/grs-dominates-public-pension-actuarial-consulting-followed-by-milliman-and-cavanaugh-macdonald/
add_row(actuarial_firm_name = "CalPERS", Year = 2016, AAL = 441500000000, UAL = 142000000000) %>% 
  arrange(desc(AAL)) %>% slice(1:10) %>% 
  
  select(-UAL) %>% 
  pivot_wider(names_from = Year,
              values_from = AAL) %>% slice(1:5) %>% 
  pivot_longer(cols = 2:3,
    names_to = "Year",
               values_to = "aal_value")

```

## Comparing top 5
```{r}
compare_top5 %>% 
  filter(Year == 2021) %>% 
  ggplot(aes(fct_reorder(actuarial_firm_name, aal_value), aal_value)) +
  geom_col(aes(y = aal_value, fill = Year))+

#year 2016
  geom_col(data = compare_top5 %>% filter(Year == 2016),
            aes(y = aal_value, fill = Year), width = 0.5) +
   coord_flip() +
  labs(x = "",
       y = "Actuarial Accrued Liability",
       title = "Top Five Actuarial Firms by AAL Values") + 
  
  scale_fill_manual(values = c("grey", "orange")) +
  scale_y_continuous(breaks = c(500000000000, 1000000000000, 1490000000000),
                   label = c("$500B","$1T","$1.5T"))+
  theme_minimal() +
  theme(panel.grid.major.y = element_blank()) 
```

# Number of plans by 15 firms - Comparing 2016-2021
```{r}
num_plan_by_firm <- final_data_16_21 %>% select(actuarial_firm_name, fy) %>% 
  
  #filter for only 15 firms
  filter(actuarial_firm_name %in% data$actuarial_firm_name) %>% 
  group_by(fy) %>% 
  add_count(actuarial_firm_name) %>% 
  rename(number_plan = n,
         Year = fy) %>% 
  mutate(Year = as.character(Year)) %>% 
  distinct()


# firms name by number of plan year 2021
num_plan_by_firm %>% filter(Year == 2021) %>% arrange(desc(number_plan))

```

## Changes in number of plans by firm
```{r}
num_plan_by_firm %>% pivot_wider(
                                 names_from = Year,
                                 values_from = number_plan) %>% 
  mutate(diff_2021_16 = `2021`-`2016` ) %>% 
  arrange(desc(diff_2021_16)) 

num_plan_by_firm %>% filter(Year == 2021)
```


```{r}

num_plan_by_firm %>% 
  ggplot(aes(fct_reorder(actuarial_firm_name, number_plan), number_plan))+
  geom_segment(aes(xend = actuarial_firm_name, yend = 0), size = 1, color = "grey") +
geom_segment(data = num_plan_by_firm %>% filter(actuarial_firm_name == "Conduent (formerly Buck and/or Xerox)"),

               aes(xend = actuarial_firm_name, yend = 10), color = "red", size = 1
               )+
  geom_point(aes(color = Year), 
             size = 6)+
  

   coord_flip()+
  labs(title = "Number of Plans by The Top 15 Firms  \n2016-2021",
        x = "",
       y = "Number of plans") + 
  theme_minimal() +
  scale_color_brewer(palette = "Set2")+
  theme(panel.grid.major.y = element_blank()) 
```

## Double-check the case of Conduent (formerly Buck and/or Xerox): from 21 plans in 2016 to 8 plans in 2021
```{r}
final_data_16_21 %>% filter(fy == 2016) %>% 
  filter(str_detect(actuarial_firm_name, "(i?)Conduent")) %>% select(PlanName) -> conduent_16_PlanName
```

```{r}
final_data_16_21 %>% filter(fy == 2021) %>% 
  filter(str_detect(actuarial_firm_name, "(i?)Conduent")) %>% select(PlanName) -> conduent_21_PlanName

# 4 plans in Reason data 
actuarial_firm_data_16_21 %>% filter(str_detect(actuarial_firm_name, "(i?)Conduent")) %>% filter(fy == 2021)

# pick up 4 more plans of 2021 NA --> pick up from supplemental file 
actuarial_firm_supplemental %>% 
  filter(str_detect(actuarial_firm_name_supplemental, "(?i)(Conduent)|(buck)|(Xerox)"))

```

Indeed, Conduent lost 13 plans to other firms. 
 Vermont State Employees 2016: Buck
https://www.vermonttreasurer.gov/sites/treasurer/files/VSERS/PDF/2016/VSERS%202016%20Valuation%20Report%20Final.pdf

 Vermont State Employees 2021: Segal
#https://www.vermonttreasurer.gov/sites/treasurer/files/2022%20VSERS%20GASB%2067%20Report.pdf

 New Jersey PERS 2021: Cheiron
 https://www.state.nj.us/treasury/pensions/documents/financial/studies/pers-exp-21.pdf


 New Jersey Police & Fire 2021: Segal
https://www.nj.gov/pfrs/documents/pdf/financial/PFRSNJ-GASB2022.pdf
```{r}
setdiff(conduent_16_PlanName, conduent_21_PlanName) -> conduent_losing_plans
```

```{r}
final_data_16_21 %>% filter(fy == 2021) %>% 
  filter(PlanName %in% conduent_losing_plans$PlanName) %>% select(fy, PlanName, actuarial_firm_name)
```


# Percentage share

```{r}
d_waffle_percentshare <- final_data_summary3_21 %>% select(actuarial_firm_name, AAL_percent) %>% 
  mutate(AAL_percent = round(AAL_percent*100)) %>% arrange(desc(AAL_percent))

waffle(c(GRS = 24, CMC = 15, Millian = 13, Segal = 11, CalPERS = 10, 
         `Others` = 100-24-15-13-11-10), rows = 5,
         title = "Percentage share of AAL by firms\n") +
  coord_equal() +
  labs(caption = "Note: Percentages are rounded up the nearest integers", size = 0.1) +
  scale_fill_manual(name = NULL,
                    values = c("#2E5079", "#3D5A42", "#0F9195", "#7FCDA1", "#B3BC92", "lightgrey")) +
  theme_void()


```
# Top 15 firms in 2021 UAL
```{r}
data %>% 
  ggplot(aes(fct_reorder(actuarial_firm_name, UAL), UAL)) +
  geom_col(fill = "#0F9195") +
  geom_col(data = data %>% filter(actuarial_firm_name == "Others"), 
           fill = "gray")+
  
  geom_text(aes(label = UAL_billion), color = "black", size = 2, 
            nudge_y = -20000000000) +
  coord_flip() +
  labs(x = "", 
       y = "UAL") +
  scale_y_continuous(breaks = c(500000000000, 1000000000000, 1490000000000),
                   label = c("$500B","$1T","$1.5T")) +
  theme(plot.margin = margin(2, 8, 6, 2, "pt")) +
  theme_minimal() 

# Comparing AAL top 5: 2016 - 2021

#Who has negative UAL/ overfuned?

data %>% filter(UAL <0)

```





